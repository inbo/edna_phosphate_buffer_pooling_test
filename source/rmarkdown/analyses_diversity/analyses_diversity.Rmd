
---
title: "Pooling vs Single supernatant DNA Extraction"
output:
  html_document:
    toc: true
    toc_depth: 2
    number_sections: false
    df_print: paged
params:
  equivalence_margin_type: "relative"   # "relative" or "absolute"
  equivalence_margin_value: 0.10        # 10% relative OR an absolute count if type == "absolute"
  random_seed: 123
---

```{r setup, include=FALSE}
library(knitr)
library(here)
opts_chunk$set(echo = TRUE, error = TRUE, out.width = "100%")
opts_knit$set(root.dir = here::here())

# ---- setup ----
knitr::opts_chunk$set(message = FALSE, warning = FALSE, fig.width = 7, fig.height = 4.5)
set.seed(params$random_seed)

libs <- c(
  "dplyr","tidyr","readr","stringr","ggplot2","glmmTMB",
  "emmeans","effectsize","TOSTER","splines","broom","broom.mixed","janitor"
)
to_install <- setdiff(libs, rownames(installed.packages()))
if (length(to_install)) install.packages(to_install, repos = "https://cloud.r-project.org")
invisible(lapply(libs, library, character.only = TRUE))

dir.create("results", showWarnings = FALSE)


pooling_test_folder <- "G:/Mijn Drive/pooling_test" # nolint

output_dir <- file.path(getwd(), "output")
if (!dir.exists(output_dir)) dir.create(output_dir)

```

```{r cache=TRUE, include=FALSE}
1+1
# een trukje om te zorgen dat de folder met figuren, die aangemaakt wordt als je
# knit, bewaard blijft
```

```{r inlezen}
diversiteit <- readr::read_csv(
  file.path(
    pooling_test_folder,
    "data", "statistiek", "dataframe_overkoepelend",
    "pooling_test_combined_dataframe_v1.csv"
  ))
  
metadata <- readr::read_csv(
  file.path(
    pooling_test_folder,
    "data",
    "metadata",
    "metadata_testpooling.csv"
  ))

diversiteit <- janitor::clean_names(diversiteit)
metadata    <- janitor::clean_names(metadata)

stopifnot(all(c("sample","observed","total_count") %in% names(diversiteit)))
stopifnot(all(c("sample","pool_or_single") %in% names(metadata)))

dat <- diversiteit %>%
  inner_join(metadata %>% select(sample, pool_or_single), by = "sample") %>%
  mutate(
    pool_or_single = factor(pool_or_single, levels = c("single","pool")),
    log_depth = log(total_count + 1),
    log_depth_c = scale(log_depth, center = TRUE, scale = FALSE)[,1]
  ) %>%
  arrange(sample, pool_or_single)


```

```{r}
# Keep only samples with both levels present
n_before <- dplyr::n_distinct(dat$sample)
paired_ids <- dat %>% count(sample) %>% filter(n == 2) %>% pull(sample)
dat <- dat %>% filter(sample %in% paired_ids)
n_after <- dplyr::n_distinct(dat$sample)

readr::write_csv(dat, "results/dat_used.csv")

cat(sprintf("Paired samples retained: %d (dropped %d unpaired if any)\n", n_after, n_before - n_after))

```

descriptives

```{r descriptives}
# ---- descriptives ----
desc <- dat %>%
  group_by(pool_or_single) %>%
  summarise(
    n_pairs = n_distinct(sample),
    mean_observed = mean(observed, na.rm = TRUE),
    median_observed = median(observed, na.rm = TRUE),
    mean_total_count = mean(total_count, na.rm = TRUE),
    .groups = "drop"
  )

readr::write_csv(desc, "results/01_descriptives.csv")

desc
```

paired differences (simple)

```{r paired-diffs-simple}
# ---- paired-differences ----
wide <- dat %>%
  select(sample, pool_or_single, observed, total_count, log_depth_c) %>%
  pivot_wider(
    names_from  = pool_or_single,
    values_from = c(observed, total_count, log_depth_c),
    names_sep = "_"
  )

paired <- wide %>%
  transmute(
    sample,
    d_observed = observed_pool - observed_single,
    rel_observed = (observed_pool - observed_single) / pmax(observed_single, 1)
  )
```

```{r}
# basic paired plot (raw, unadjusted for depth)
gp1 <- dat %>%
  ggplot(aes(pool_or_single, observed, group = sample)) +
  geom_line(alpha = 0.35) +
  geom_point() +
  labs(title = "Observed richness (raw): pool vs single", x = NULL, y = "Observed richness")

ggsave("results/plot_01_raw_paired_observed.png", gp1, width = 7, height = 4.5, dpi = 300)

gp1

```

```{r}
# distribution of paired raw differences
gp2 <- paired %>%
  ggplot(aes(y = d_observed, x = 1)) +
  geom_boxplot(width = 0.15, outlier.shape = NA) +
  geom_jitter(width = 0.05, alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = 2) +
  scale_x_continuous(breaks = NULL) +
  labs(title = "Paired raw difference: pool - single", y = "Difference in observed richness")

ggsave("results/plot_02_raw_difference_box.png", gp2, width = 6, height = 4, dpi = 300)

gp2

```

sequencing depth adjusted model (primary analysis)

```{r sequencing-depth-adjusted-model}
# ---- model-nb ----
# Negative binomial mixed model: observed ~ pool_or_single + log_depth_c + (1 | sample)
m_nb <- glmmTMB(
  observed ~ pool_or_single + log_depth_c + (1 | sample),
  family = nbinom2,
  data = dat
)
summ_nb <- broom.mixed::tidy(m_nb, effects = "fixed", conf.int = TRUE, conf.level = 0.95)

readr::write_csv(summ_nb, "results/02_model_nb_fixed_effects.csv")

# Optional: Nonlinear depth via spline
m_nb_spline <- glmmTMB(
  observed ~ pool_or_single + splines::ns(log_depth, df = 3) + (1 | sample),
  family = nbinom2, data = dat
)

aic_tab <- tibble(
  model = c("NB linear depth","NB spline depth(df=3)"),
  AIC   = AIC(m_nb), 
  AIC_spline = AIC(m_nb_spline)
)

readr::write_csv(aic_tab, "results/02_model_nb_aic_compare.csv")

```

```{r}
summ_nb
```

```{r}
aic_tab
```


Depth-adjusted Pool vs Single Contrast

```{r contrasts}
# ---- emmeans-contrast ----
emm <- emmeans::emmeans(m_nb, ~ pool_or_single, cov.reduce = list(log_depth_c = mean))
contrast_link   <- pairs(emm)                         # link scale
contrast_resp   <- pairs(emm, type = "response")      # response (count) scale with delta method

tbl_link <- broom::tidy(contrast_link, conf.int = TRUE)
tbl_resp <- broom::tidy(contrast_resp, conf.int = TRUE)

```

```{r}
tbl_link
```


```{r}
tbl_resp
```

```{r}
readr::write_csv(tbl_link, "results/03_emm_contrast_link.csv")
readr::write_csv(tbl_resp, "results/03_emm_contrast_response.csv")
```

```{r plot-on-response}
# Quick forest-style plot on response scale
gp3 <- as.data.frame(contrast_resp) %>%
  mutate(label = paste(contrast, sprintf("(p=%.3f)", p.value))) %>%
  ggplot(aes(x = label, y = estimate, ymin = lower.CL, ymax = upper.CL)) +
  geom_pointrange() +
  coord_flip() +
  labs(title = "Depth-adjusted contrast (response scale)", x = NULL, y = "Difference in expected richness")

ggsave("results/plot_03_emm_contrast_response.png", gp3, width = 7, height = 3.8, dpi = 300)

gp3
```

Paired Residual Test (depth-adjusted)

```{r paired-residual-test-depth-adjusted}
# ---- residual-paired-test ----
# Remove treatment to estimate depth-only trend, then test paired residuals
m_depth <- glmmTMB(observed ~ log_depth_c + (1 | sample), family = nbinom2, data = dat)

# Response residuals: observed - fitted  (depth-adjusted departures)
dat$resid_resp <- residuals(m_depth, type = "response")

res_wide <- dat %>%
  select(sample, pool_or_single, resid_resp) %>%
  pivot_wider(names_from = pool_or_single, values_from = resid_resp) %>%
  mutate(d_resid = pool - single)

sh <- shapiro.test(res_wide$d_resid)
if (sh$p.value >= 0.05) {
  paired_test <- t.test(res_wide$d_resid, mu = 0)
  eff <- effectsize::cohens_d(res_wide$d_resid ~ 1, mu = 0, paired = FALSE)
  test_used <- "paired t-test on residual differences (implemented as one-sample t on d)"
} else {
  paired_test <- wilcox.test(res_wide$d_resid, mu = 0, exact = FALSE)
  eff <- effectsize::rank_biserial(res_wide$d_resid ~ 1, mu = 0)
  test_used <- "Wilcoxon signed-rank on residual differences"
}

paired_summary <- tibble(
  test = test_used,
  shapiro_p = sh$p.value,
  statistic = unname(paired_test$statistic),
  p_value = paired_test$p.value,
  estimate_mean = mean(res_wide$d_resid, na.rm = TRUE),
  ci_low = if (!is.null(paired_test$conf.int)) paired_test$conf.int[1] else NA_real_,
  ci_high = if (!is.null(paired_test$conf.int)) paired_test$conf.int[2] else NA_real_
)

readr::write_csv(paired_summary, "results/04_paired_residual_test.csv")

paired_summary
```

Equivalence (TOST) — “single is not meaningfully worse”

```{r equivalence-tost-single-is-not-worse}
# ---- tost ----
# We'll test on depth-adjusted residual differences (pool - single).
d <- res_wide$d_resid
d <- d[is.finite(d)]

# Define equivalence margin
if (params$equivalence_margin_type == "relative") {
  m_single <- dat %>% filter(pool_or_single == "single") %>% summarise(m = mean(observed, na.rm = TRUE)) %>% pull(m)
  eq_margin <- params$equivalence_margin_value * m_single
} else {
  eq_margin <- params$equivalence_margin_value
}

tost <- TOSTER::TOSTone(
  m = mean(d, na.rm = TRUE),
  sd = stats::sd(d, na.rm = TRUE),
  n  = sum(!is.na(d)),
  low_eqbound = -eq_margin,
  high_eqbound =  eq_margin,
  alpha = 0.05
)

# TOST summary table
tost_tab <- tibble(
  mean_diff = mean(d, na.rm = TRUE),
  sd_diff   = sd(d, na.rm = TRUE),
  n         = sum(!is.na(d)),
  eq_margin = eq_margin,
  p_lower   = tost$LOW_p,
  p_upper   = tost$UP_p,
  p_equiv   = max(tost$LOW_p, tost$UP_p),   # both must be < alpha for equivalence
  ci_low    = tost$TOST_confint[1],
  ci_high   = tost$TOST_confint[2]
)

readr::write_csv(tost_tab, "results/05_tost_equivalence.csv")

```

```{r}
tost_tab
```

diagnostics and robustness

```{r diagnostics-and-robustness}
# ---- diagnostics ----
# Interaction: does pooling change the depth–richness slope?
m_int <- glmmTMB(
  observed ~ pool_or_single * log_depth_c + (1 | sample),
  family = nbinom2, data = dat
)
anova_slope <- anova(m_nb, m_int)

readr::write_csv(broom::tidy(anova_slope), "results/06_slope_interaction_lrt.csv")

```

```{r}
anova_slope
```

```{r}
# Influence of very low depth: quick sensitivity (drop bottom 5% by total_count)
cutoff <- quantile(dat$total_count, 0.05, na.rm = TRUE)
dat_sens <- dat %>% filter(total_count >= cutoff)

m_nb_sens <- glmmTMB(
  observed ~ pool_or_single + log_depth_c + (1 | sample),
  family = nbinom2, data = dat_sens
)
emm_sens <- pairs(emmeans(m_nb_sens, ~ pool_or_single, cov.reduce = list(log_depth_c = mean)), type = "response")
sens_tbl <- broom::tidy(emm_sens, conf.int = TRUE)

readr::write_csv(sens_tbl, "results/07_sensitivity_emm_response.csv")

sens_tbl
```

visuals

```{r}
# ---- visuals-adjusted ----
# Partial effect plot: adjusted means at avg depth
emm_resp <- as.data.frame(emmeans(m_nb, ~ pool_or_single, type = "response",
                                  cov.reduce = list(log_depth_c = mean)))
gp4 <- ggplot(emm_resp, aes(x = pool_or_single, y = response)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.15) +
  labs(title = "Depth-adjusted expected richness", x = NULL, y = "Expected richness (response scale)")

ggsave("results/plot_04_emmeans_adjusted.png", gp4, width = 5.5, height = 4, dpi = 300)



```

```{r}
gp4
```

```{r}
# Residual paired difference plot (depth-adjusted)
gp5 <- res_wide %>%
  ggplot(aes(y = d_resid, x = 1)) +
  geom_boxplot(width = 0.15, outlier.shape = NA) +
  geom_jitter(width = 0.05, alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = 2) +
  scale_x_continuous(breaks = NULL) +
  labs(title = "Depth-adjusted paired difference (residuals): pool - single", y = "Difference (residual counts)")

ggsave("results/plot_05_residual_difference.png", gp5, width = 6, height = 4, dpi = 300)

gp5
```

takeaways

```{r}
out_contrast <- tbl_resp %>% select(contrast, estimate, conf.low, conf.high, p.value)
out_tost     <- tost_tab %>% select(mean_diff, eq_margin, p_equiv, ci_low, ci_high)
out_pair     <- paired_summary

list(
  depth_adjusted_contrast = out_contrast,
  paired_residual_test = out_pair,
  equivalence_tost = out_tost,
  model_aic = aic_tab
)

```

